# Package Handler library
#
# Include this file before you invoke pkg_xxx functions.
#
# These are the routines that implement local package handling.
# Specifically, there is support for installing them.
#
# These routines detect the current operation system and/or
# packaging discipline, with a fallback on apt under Debian.
#
# All packages are named as on Debian Linux, at least for now,
# so translation may be necessary.
#
# From: Rick van Rein <rick@openfortress.nl>



# Only run through this file once
#
[ -z $PKGLIB_TYPE ] || exit 0


# Use "uname" output to determine the packaging system,
# possibly drilling down more if needed.
#
case $(uname) in

MSYS_NT-10.0|MSYS_NT-*)
	PKGLIB_TYPE=msys
	;;

OpenBSD)
	PKGLIB_TYPE=openbsd
	;;

*)
	PKGLIB_TYPE=debian
	;;

esac


#
# Form an associative array for translations
#
unset pkg_xlate
declare -A pkg_xlate
if [ -r $(dirname "$0")/xlate/$PKGLIB_TYPE ]
then
	cat $(dirname "$0")/xlate/$PKGLIB_TYPE |
	while read KEY SUBSTITUTES
	do
		pkg_xlate["$KEY"]="$SUBSTITUTES"
	done
fi
#
OUTPUT=()
for PKG in "$@"
do
	if $PKG in pkg_xlate
	then
		OUTPUT+=( $pkg_xlate[$PKG] )
	else
		OUTPUT+=( $PKG )
	fi
done
set -- $OUTPUT


#
# Obliged functions to implement:
#
# pkg_install x y z --> install packages named x, y and z.
# pkg_listfiles x --> list files in package named x.
# pkg_update --> update all OS packages.
#



#
# Debian packages, using apt/dpkg
#

if [ $PKGLIB_TYPE = debian ]
then

	pkg_install() {
		apt -y install "$@"
	}

	pkg_listfiles() {
		dpkg -L "$1"
	}

	pkg_update() {
		apt-get update && apt-get upgrade
	}

fi


#
# MSYS packages
#

if [ $PKGLIB_TYPE == msys ]
then

	pkg_install() {
		ARGV=()
		for ARGI in "$@"
		do
			ARGV+=( "mingw-w64-x86_64-$ARGI" )
		done
		pacman --config /etc/pacman-msys.conf -U "${ARGV[@]}"
	}

	pkg_listfiles() {
		# pacman can list multiple packages, we only use one
		pacman --config /etc/pacman-msys.conf -Q -l "mingw-w64-x86_64-$1"
	}

	pkg_update() {
		pacman --config /etc/pacman-msys.conf -Syu
	}

fi


#
# OpenBSD packages
#

if [ $PKGLIB_TYPE == openbsd ]
then

	pkg_install() {
		pkg_add "$@"
	}

	pkg_listfiles() {
		pkg_info -L "$1" | sed '1,/^Files:$/d'
	}

	pkg_update() {
		pkg_add -u
	}

fi


